<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VVV Unstaking Queue Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg: #0b0f18;
      --panel: #111827;
      --panel-2: #0f172a;
      --text: #e6edf7;
      --muted: #94a3b8;
      --accent: #3b82f6;
      --accent-2: #22d3ee;
      --grid: #1f2937;
      --border: #1e293b;
    }
    body { margin:0; font-family: Inter, system-ui, sans-serif; background: var(--bg); color: var(--text); }
    .container { max-width: 1200px; margin: 0 auto; padding: 32px; }
    h1 { margin: 0 0 8px; font-size: 28px; letter-spacing: .2px; font-weight: 600; }
    .subtitle { color: var(--muted); margin-bottom: 24px; }
    .grid { display: grid; gap: 16px; }
    .kpis { grid-template-columns: repeat(4, minmax(0,1fr)); }
    .panel { background: var(--panel); border: 1px solid var(--border); border-radius: 8px; padding: 16px; box-shadow: none; }
    .kpi-title { color: var(--muted); font-size: 12px; text-transform: uppercase; letter-spacing: .08em; }
    .kpi-value { font-size: 26px; margin-top: 6px; font-variant-numeric: tabular-nums; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .kpi-delta { font-size: 12px; margin-top: 4px; color: var(--accent-2); }
    .charts { grid-template-columns: 1fr; }
    .forecast-list { list-style: none; margin: 0; padding: 0; }
    .forecast-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border); }
    .forecast-item:last-child { border-bottom: none; }
    .forecast-date { color: var(--muted); font-size: 13px; }
    .forecast-amount { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 16px; font-weight: 600; }
    .forecast-change { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 13px; margin-left: 12px; }
    .forecast-change.positive { color: var(--accent-2); }
    .forecast-change.negative { color: #ef4444; }
    .forecast-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--border); }
    .forecast-title { font-size: 14px; font-weight: 600; }
    @media (max-width: 900px) { .kpis { grid-template-columns: repeat(2,1fr);} }
    @media (max-width: 600px) {
      .container { padding: 20px; }
      h1 { font-size: 22px; }
      .subtitle { font-size: 13px; line-height: 1.4; }
      .kpis { grid-template-columns: 1fr; }
      .panel { padding: 12px; }
      .kpi-value { font-size: 22px; }
      canvas { max-height: 260px; }
    }
    .footer { color: var(--muted); font-size: 12px; margin-top: 18px; }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body>
  <div class="container">
    <h1>VVV Unstaking Queue - 30 Day Story</h1>
    <div class="subtitle">sVVV initiateUnstake on Base. 7-day cooldown before tokens become freely transferable. Updated every 12 hours.</div>

    <div class="grid kpis" id="kpis"></div>

    <div class="grid charts" style="margin-top:16px;">
      <div class="panel"><canvas id="initUnlockChart"></canvas></div>
      <div class="panel"><canvas id="initChart"></canvas></div>
      <div class="panel" id="forecastPanel">
        <div class="forecast-header">
          <span class="forecast-title">Upcoming Unlocks (Next 7 Days)</span>
          <span style="color: var(--muted); font-size: 12px;">Tokens becoming freely tradable</span>
        </div>
        <ul class="forecast-list" id="forecastList"></ul>
      </div>
    </div>

    <div class="panel" style="margin-top:16px;">
      <strong>How to read this:</strong><br>
      • <strong>Initiated</strong> = when a user called <code>initiateUnstake</code> (cooldown starts)<br>
      • <strong>Unlock</strong> = 7 days after initiation (cooldown ends, tokens become transferable)<br>
      • <strong>Queue</strong> = total sVVV currently in cooldown (sum of last 7 days of initiations)<br><br>
      The unlock chart shows when tokens become freely sellable — spikes indicate potential sell pressure.
    </div>

    <div class="footer">Data refresh: every 12 hours. Sources: Dune (unstaking via sVVV), CoinGecko (price). Public dashboard uses static JSON with no embedded keys.</div>
  </div>

  <script>
    async function loadJSON(path) {
      const res = await fetch(path, { cache: 'no-cache' });
      return res.json();
    }

    function fmt(n) {
      if (n === null || n === undefined) return '0';
      const abs = Math.abs(n);
      if (abs >= 1e9) return (n/1e9).toFixed(2) + 'B';
      if (abs >= 1e6) return (n/1e6).toFixed(2) + 'M';
      if (abs >= 1e3) return (n/1e3).toFixed(2) + 'K';
      return Number(n).toFixed(2);
    }

    (async () => {
      const daily = await loadJSON('data/daily.json');
      const summaryArr = await loadJSON('data/summary.json');
      const summary = summaryArr[0] || {};

      const labels = daily.map(d => d.day);
      const queue = daily.map(d => Number(d.queue_amount || 0));
      const initiated = daily.map(d => Number(d.initiated_amount || 0));
      const unlocks = daily.map(d => Number(d.unlock_amount || 0));
      const rawPrice = daily.map(d => d.vvv_price_usd === null || d.vvv_price_usd === undefined ? null : Number(d.vvv_price_usd));
      const price = [];
      let last = null;
      for (const p of rawPrice) {
        if (p !== null && !Number.isNaN(p)) last = p;
        price.push(last);
      }

      const currentQueue = Number(summary.current_queue_amount || 0);
      const avgQueue = Number(summary.avg_queue_amount_30d || 0);
      const avgDailyInit = Number(summary.avg_daily_initiated_30d || 0);
      const init7d = Number(summary.initiated_last_7d || 0);

      const avgUnlock = unlocks.reduce((a,b)=>a+b,0) / Math.max(unlocks.length,1);

      const delta = avgQueue === 0 ? 0 : ((currentQueue - avgQueue) / avgQueue) * 100;
      const deltaText = (delta >= 0 ? '+' : '') + delta.toFixed(1) + '% vs 30d avg';

      const kpis = [
        { title: 'Current Queue (7d)', value: fmt(currentQueue), sub: deltaText },
        { title: '30d Avg Queue', value: fmt(avgQueue), sub: 'Baseline' },
        { title: '30d Avg Daily Initiated', value: fmt(avgDailyInit), sub: 'Daily flow' },
        { title: 'Initiated Last 7d', value: fmt(init7d), sub: 'Recent pressure' }
      ];

      const kpiContainer = document.getElementById('kpis');
      kpis.forEach(k => {
        const div = document.createElement('div');
        div.className = 'panel';
        div.innerHTML = `<div class="kpi-title">${k.title}</div><div class="kpi-value">${k.value}</div><div class="kpi-delta">${k.sub}</div>`;
        kpiContainer.appendChild(div);
      });

      const axisColor = '#94a3b8';
      const gridColor = '#1f2937';
      const legendColor = '#e6edf7';

      const priceNums = price.filter(v => v !== null && v !== undefined);
      const priceMin = priceNums.length ? Math.min(...priceNums) : 0;
      const priceMax = priceNums.length ? Math.max(...priceNums) : 1;

      const avgUnlockLine = labels.map(() => avgUnlock);

      new Chart(document.getElementById('initUnlockChart'), {
        type: 'line',
        data: { labels, datasets: [
          { label: 'Unlocks (Tokens Become Transferable)', data: unlocks, borderColor: '#22d3ee', backgroundColor: 'rgba(34,211,238,0.12)', fill: true, tension: 0.2, yAxisID: 'y' },
          { label: 'Avg Daily Unlocks (30d)', data: avgUnlockLine, borderColor: '#3b82f6', borderDash: [6,6], pointRadius: 0, tension: 0, yAxisID: 'y' },
          { label: 'VVV Price (USD)', data: price, borderColor: '#f59e0b', backgroundColor: 'rgba(245,158,11,0.10)', fill: false, tension: 0.2, yAxisID: 'y1', borderWidth: 2, pointRadius: 2 }
        ]},
        options: {
          plugins: { legend: { labels: { color: legendColor } } },
          scales: {
            x: { ticks: { color: axisColor, maxRotation: 0, autoSkip: true, maxTicksLimit: 10 }, grid: { color: gridColor } },
            y: { position: 'left', ticks: { color: axisColor }, grid: { color: gridColor }, title: { display: true, text: 'Unlocks', color: axisColor } },
            y1: {
              position: 'right',
              grid: { drawOnChartArea: false },
              ticks: { color: axisColor, callback: (v) => '$' + Number(v).toFixed(2) },
              title: { display: true, text: 'Price (USD)', color: axisColor },
              suggestedMin: priceMin * 0.9,
              suggestedMax: priceMax * 1.1
            }
          }
        }
      });

      new Chart(document.getElementById('initChart'), {
        type: 'bar',
        data: { labels, datasets: [{ label: 'Initiated (Cooldown Starts)', data: initiated, backgroundColor: '#3b82f6' }] },
        options: {
          plugins: { legend: { labels: { color: legendColor } } },
          scales: {
            x: { ticks: { color: axisColor, maxRotation: 0, autoSkip: true, maxTicksLimit: 10 }, grid: { color: gridColor } },
            y: { ticks: { color: axisColor }, grid: { color: gridColor } }
          }
        }
      });

      // Generate 7-day unlock forecast based on initiations 7 days ago
      const today = new Date();
      const forecast = [];
      for (let i = 0; i < 7; i++) {
        const unlockDate = new Date(today);
        unlockDate.setDate(today.getDate() + i);
        const unlockDateStr = unlockDate.toISOString().slice(0, 10);
        
        // Find initiations from 7 days prior to this unlock date
        const initDate = new Date(unlockDate);
        initDate.setDate(unlockDate.getDate() - 7);
        const initDateStr = initDate.toISOString().slice(0, 10);
        
        const initData = daily.find(d => d.day === initDateStr);
        const amount = initData ? Number(initData.initiated_amount || 0) : 0;
        
        forecast.push({ date: unlockDateStr, amount: amount });
      }

      // Render forecast list with % change
      const forecastList = document.getElementById('forecastList');
      forecast.forEach((item, idx) => {
        const li = document.createElement('li');
        li.className = 'forecast-item';
        
        const dateEl = document.createElement('span');
        dateEl.className = 'forecast-date';
        const dateObj = new Date(item.date);
        const dateFmt = dateObj.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        dateEl.textContent = idx === 0 ? `Today — ${dateFmt}` : dateFmt;
        
        const rightEl = document.createElement('div');
        rightEl.style.display = 'flex';
        rightEl.style.alignItems = 'center';
        
        const amountEl = document.createElement('span');
        amountEl.className = 'forecast-amount';
        amountEl.textContent = fmt(item.amount) + ' VVV';
        
        rightEl.appendChild(amountEl);
        
        if (idx > 0) {
          const prevAmount = forecast[idx - 1].amount;
          const changeEl = document.createElement('span');
          changeEl.className = 'forecast-change';
          if (prevAmount > 0) {
            const pct = ((item.amount - prevAmount) / prevAmount) * 100;
            const sign = pct >= 0 ? '+' : '';
            changeEl.textContent = `${sign}${pct.toFixed(1)}%`;
            changeEl.classList.add(pct >= 0 ? 'positive' : 'negative');
          } else if (item.amount > 0) {
            changeEl.textContent = 'New';
            changeEl.classList.add('positive');
          } else {
            changeEl.textContent = '—';
          }
          rightEl.appendChild(changeEl);
        }
        
        li.appendChild(dateEl);
        li.appendChild(rightEl);
        forecastList.appendChild(li);
      });

    })();
  </script>
</body>
</html>
