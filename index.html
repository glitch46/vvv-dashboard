<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VVV Unstaking Queue Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg: #0b0f18;
      --panel: #111827;
      --panel-2: #0f172a;
      --text: #e6edf7;
      --muted: #94a3b8;
      --accent: #3b82f6;
      --accent-2: #22d3ee;
      --grid: #1f2937;
      --border: #1e293b;
    }
    body { margin:0; font-family: Inter, system-ui, sans-serif; background: var(--bg); color: var(--text); }
    .container { max-width: 1200px; margin: 0 auto; padding: 32px; }
    h1 { margin: 0 0 8px; font-size: 28px; letter-spacing: .2px; font-weight: 600; }
    .subtitle { color: var(--muted); margin-bottom: 24px; }
    .grid { display: grid; gap: 16px; }
    .kpis { grid-template-columns: repeat(4, minmax(0,1fr)); }
    .panel { background: var(--panel); border: 1px solid var(--border); border-radius: 8px; padding: 16px; box-shadow: none; }
    .kpi-title { color: var(--muted); font-size: 12px; text-transform: uppercase; letter-spacing: .08em; }
    .kpi-value { font-size: 26px; margin-top: 6px; font-variant-numeric: tabular-nums; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .kpi-delta { font-size: 12px; margin-top: 4px; color: var(--accent-2); }
    .charts { grid-template-columns: 1fr; }
    @media (max-width: 900px) { .kpis { grid-template-columns: repeat(2,1fr);} }
    @media (max-width: 600px) { .kpis { grid-template-columns: 1fr;} }
    .footer { color: var(--muted); font-size: 12px; margin-top: 18px; }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body>
  <div class="container">
    <h1>VVV Unstaking Queue - 30 Day Story</h1>
    <div class="subtitle">sVVV initiateUnstake on Base. 7-day cooldown before tokens become freely transferable. Updated every 12 hours.</div>

    <div class="grid kpis" id="kpis"></div>

    <div class="grid charts" style="margin-top:16px;">
      <div class="panel"><canvas id="queueChart"></canvas></div>
      <div class="panel"><canvas id="initUnlockChart"></canvas></div>
      <div class="panel"><canvas id="initChart"></canvas></div>
      <div class="panel"><canvas id="unlockVolumePriceChart"></canvas></div>
    </div>

    <div class="panel" style="margin-top:16px;">
      <strong>How to read this:</strong><br>
      • <strong>Initiated</strong> = when a user called <code>initiateUnstake</code> (cooldown starts)<br>
      • <strong>Unlock</strong> = 7 days after initiation (cooldown ends, tokens become transferable)<br>
      • <strong>Queue</strong> = total sVVV currently in cooldown (sum of last 7 days of initiations)<br><br>
      The unlock chart shows when tokens become freely sellable — spikes indicate potential sell pressure.
    </div>

    <div class="footer">Data refresh: every 12 hours. Source: Dune API. Public dashboard uses static JSON with no embedded keys.</div>
  </div>

  <script>
    async function loadJSON(path) {
      const res = await fetch(path, { cache: 'no-cache' });
      return res.json();
    }

    function fmt(n) {
      if (n === null || n === undefined) return '0';
      const abs = Math.abs(n);
      if (abs >= 1e9) return (n/1e9).toFixed(2) + 'B';
      if (abs >= 1e6) return (n/1e6).toFixed(2) + 'M';
      if (abs >= 1e3) return (n/1e3).toFixed(2) + 'K';
      return Number(n).toFixed(2);
    }

    (async () => {
      const daily = await loadJSON('data/daily.json');
      const summaryArr = await loadJSON('data/summary.json');
      const summary = summaryArr[0] || {};

      const labels = daily.map(d => d.day);
      const queue = daily.map(d => Number(d.queue_amount || 0));
      const initiated = daily.map(d => Number(d.initiated_amount || 0));
      const unlocks = daily.map(d => Number(d.unlock_amount || 0));
      const rawPrice = daily.map(d => d.vvv_price_usd === null || d.vvv_price_usd === undefined ? null : Number(d.vvv_price_usd));
      const price = [];
      let last = null;
      for (const p of rawPrice) {
        if (p !== null && !Number.isNaN(p)) last = p;
        price.push(last);
      }

      const rawVol = daily.map(d => d.trade_volume_usd === null || d.trade_volume_usd === undefined ? null : Number(d.trade_volume_usd));
      const tradeVol = [];
      let vlast = null;
      for (const v of rawVol) {
        if (v !== null && !Number.isNaN(v)) vlast = v;
        tradeVol.push(vlast);
      }

      const currentQueue = Number(summary.current_queue_amount || 0);
      const avgQueue = Number(summary.avg_queue_amount_30d || 0);
      const avgDailyInit = Number(summary.avg_daily_initiated_30d || 0);
      const init7d = Number(summary.initiated_last_7d || 0);

      const avgUnlock = unlocks.reduce((a,b)=>a+b,0) / Math.max(unlocks.length,1);

      const delta = avgQueue === 0 ? 0 : ((currentQueue - avgQueue) / avgQueue) * 100;
      const deltaText = (delta >= 0 ? '+' : '') + delta.toFixed(1) + '% vs 30d avg';

      const kpis = [
        { title: 'Current Queue (7d)', value: fmt(currentQueue), sub: deltaText },
        { title: '30d Avg Queue', value: fmt(avgQueue), sub: 'Baseline' },
        { title: '30d Avg Daily Initiated', value: fmt(avgDailyInit), sub: 'Daily flow' },
        { title: 'Initiated Last 7d', value: fmt(init7d), sub: 'Recent pressure' }
      ];

      const kpiContainer = document.getElementById('kpis');
      kpis.forEach(k => {
        const div = document.createElement('div');
        div.className = 'panel';
        div.innerHTML = `<div class="kpi-title">${k.title}</div><div class="kpi-value">${k.value}</div><div class="kpi-delta">${k.sub}</div>`;
        kpiContainer.appendChild(div);
      });

      const labelsForward = [...labels, ...Array.from({length: 7}, (_, i) => {
        const d = new Date(labels[labels.length-1]);
        d.setDate(d.getDate() + (i+1));
        return d.toISOString().slice(0,10);
      })];
      const unlocksForward = [...unlocks, ...Array(7).fill(null)];
      const avgUnlockLine = labelsForward.map(() => avgUnlock);

      const axisColor = '#94a3b8';
      const gridColor = '#1f2937';
      const legendColor = '#e6edf7';

      new Chart(document.getElementById('queueChart'), {
        type: 'line',
        data: {
          labels: labelsForward,
          datasets: [
            { label: 'Unlocks (Cooldown Ends)', data: unlocksForward, borderColor: '#22d3ee', backgroundColor: 'rgba(34,211,238,0.12)', fill: true, tension: 0.2 },
            { label: 'Avg Daily Unlocks (30d)', data: avgUnlockLine, borderColor: '#3b82f6', borderDash: [6,6], pointRadius: 0, tension: 0 }
          ]
        },
        options: {
          plugins: { legend: { labels: { color: legendColor } } },
          scales: {
            x: { ticks: { color: axisColor, maxRotation: 0, autoSkip: true, maxTicksLimit: 10 }, grid: { color: gridColor } },
            y: { ticks: { color: axisColor }, grid: { color: gridColor } }
          }
        }
      });

      const priceNums = price.filter(v => v !== null && v !== undefined);
      const priceMin = priceNums.length ? Math.min(...priceNums) : 0;
      const priceMax = priceNums.length ? Math.max(...priceNums) : 1;

      new Chart(document.getElementById('initUnlockChart'), {
        type: 'line',
        data: { labels, datasets: [
          { label: 'Unlocks (Tokens Become Transferable)', data: unlocks, borderColor: '#22d3ee', backgroundColor: 'rgba(34,211,238,0.12)', fill: true, tension: 0.2, yAxisID: 'y' },
          { label: 'VVV Price (USD)', data: price, borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.10)', fill: false, tension: 0.2, yAxisID: 'y1', borderWidth: 2, pointRadius: 2 }
        ]},
        options: {
          plugins: { legend: { labels: { color: legendColor } } },
          scales: {
            x: { ticks: { color: axisColor, maxRotation: 0, autoSkip: true, maxTicksLimit: 10 }, grid: { color: gridColor } },
            y: { position: 'left', ticks: { color: axisColor }, grid: { color: gridColor }, title: { display: true, text: 'Unlocks', color: axisColor } },
            y1: {
              position: 'right',
              grid: { drawOnChartArea: false },
              ticks: { color: axisColor, callback: (v) => '$' + Number(v).toFixed(2) },
              title: { display: true, text: 'Price (USD)', color: axisColor },
              suggestedMin: priceMin * 0.9,
              suggestedMax: priceMax * 1.1
            }
          }
        }
      });

      new Chart(document.getElementById('initChart'), {
        type: 'bar',
        data: { labels, datasets: [{ label: 'Initiated (Cooldown Starts)', data: initiated, backgroundColor: '#3b82f6' }] },
        options: {
          plugins: { legend: { labels: { color: legendColor } } },
          scales: {
            x: { ticks: { color: axisColor, maxRotation: 0, autoSkip: true, maxTicksLimit: 10 }, grid: { color: gridColor } },
            y: { ticks: { color: axisColor }, grid: { color: gridColor } }
          }
        }
      });

      // Unlocks + Trade Volume + Price (same day)
      const volNums = tradeVol.filter(v => v !== null && v !== undefined);
      const volMin = volNums.length ? Math.min(...volNums) : 0;
      const volMax = volNums.length ? Math.max(...volNums) : 1;

      new Chart(document.getElementById('unlockVolumePriceChart'), {
        type: 'bar',
        data: { labels, datasets: [
          { label: 'Unlocks (Cooldown Ends)', data: unlocks, backgroundColor: 'rgba(34,211,238,0.45)', yAxisID: 'y' },
          { label: 'Trade Volume (USD)', data: tradeVol, backgroundColor: 'rgba(59,130,246,0.45)', yAxisID: 'y1' },
          { label: 'VVV Price (USD)', data: price, type: 'line', borderColor: '#22d3ee', backgroundColor: 'rgba(34,211,238,0.15)', yAxisID: 'y2', tension: 0.2, borderWidth: 2, pointRadius: 2 }
        ]},
        options: {
          plugins: { legend: { labels: { color: legendColor } } },
          scales: {
            x: { ticks: { color: axisColor, maxRotation: 0, autoSkip: true, maxTicksLimit: 10 }, grid: { color: gridColor } },
            y: { position: 'left', ticks: { color: axisColor }, grid: { color: gridColor }, title: { display: true, text: 'Unlocks', color: axisColor } },
            y1: { position: 'right', ticks: { color: axisColor, callback: (v) => '$' + Number(v).toFixed(0) }, grid: { drawOnChartArea: false }, title: { display: true, text: 'Trade Volume (USD)', color: axisColor }, suggestedMin: volMin * 0.9, suggestedMax: volMax * 1.1 },
            y2: { position: 'right', ticks: { color: axisColor, callback: (v) => '$' + Number(v).toFixed(2) }, grid: { drawOnChartArea: false }, title: { display: true, text: 'Price (USD)', color: axisColor }, suggestedMin: priceMin * 0.9, suggestedMax: priceMax * 1.1 }
          }
        }
      });
    })();
  </script>
</body>
</html>
