<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VVV Unstaking Queue Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg: #0f1220;
      --panel: #151c2f;
      --text: #eef3ff;
      --muted: #a8b8d8;
      --accent: #6ea8ff;
      --accent2: #8be9b5;
      --accent3: #ffd18a;
      --accent4: #c3a6ff;
      --danger: #ff7a7a;
    }
    body { margin:0; font-family: Inter, system-ui, sans-serif; background: radial-gradient(1000px 600px at 10% -10%, #1a2340 0%, var(--bg) 60%); color: var(--text); }
    .container { max-width: 1200px; margin: 0 auto; padding: 28px; }
    h1 { margin: 0 0 8px; font-size: 30px; letter-spacing: .2px; }
    .subtitle { color: var(--muted); margin-bottom: 22px; }
    .grid { display: grid; gap: 16px; }
    .kpis { grid-template-columns: repeat(4, minmax(0,1fr)); }
    .panel { background: linear-gradient(180deg, #171f34 0%, #131a2c 100%); border-radius: 14px; padding: 16px; box-shadow: 0 6px 20px rgba(0,0,0,.25); }
    .kpi-title { color: var(--muted); font-size: 12px; text-transform: uppercase; letter-spacing: .06em; }
    .kpi-value { font-size: 26px; margin-top: 6px; }
    .kpi-delta { font-size: 12px; margin-top: 4px; color: #cfe0ff; }
    .charts { grid-template-columns: 1fr; }
    @media (max-width: 900px) { .kpis { grid-template-columns: repeat(2,1fr);} }
    @media (max-width: 600px) { .kpis { grid-template-columns: 1fr;} }
    .footer { color: var(--muted); font-size: 12px; margin-top: 18px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>VVV Unstaking Queue — 30 Day Story</h1>
    <div class="subtitle">sVVV initiateUnstake(0xae5ac921) on Base. Cooldown = 7 days. Simple, human‑readable, and updated twice daily.</div>

    <div class="grid kpis" id="kpis"></div>

    <div class="grid charts" style="margin-top:16px;">
      <div class="panel"><canvas id="queueChart"></canvas></div>
      <div class="panel"><canvas id="initUnlockChart"></canvas></div>
      <div class="panel"><canvas id="initChart"></canvas></div>
    </div>

    <div class="panel" style="margin-top:16px;">
      <strong>Story:</strong> Unlocks are just initiations shifted 7 days forward. The first chart shows daily unlocks plus the 30‑day baseline so you can see if today’s unlocks are heavy or light. Queue pressure is simply the last 7 days of initiations stacked together.
    </div>

    <div class="footer">Data refresh: every 12 hours. Source: Dune API.</div>
  </div>

  <script>
    async function loadJSON(path) {
      const res = await fetch(path, { cache: 'no-cache' });
      return res.json();
    }

    function fmt(n) {
      if (n === null || n === undefined) return '0';
      const abs = Math.abs(n);
      if (abs >= 1e9) return (n/1e9).toFixed(2) + 'B';
      if (abs >= 1e6) return (n/1e6).toFixed(2) + 'M';
      if (abs >= 1e3) return (n/1e3).toFixed(2) + 'K';
      return Number(n).toFixed(2);
    }

    (async () => {
      const daily = await loadJSON('data/daily.json');
      const summaryArr = await loadJSON('data/summary.json');
      const summary = summaryArr[0] || {};

      const labels = daily.map(d => d.day);
      const queue = daily.map(d => Number(d.queue_amount || 0));
      const initiated = daily.map(d => Number(d.initiated_amount || 0));
      const unlocks = daily.map(d => Number(d.unlock_amount || 0));
      const rawPrice = daily.map(d => d.vvv_price_usd === null || d.vvv_price_usd === undefined ? null : Number(d.vvv_price_usd));
      const price = [];
      let last = null;
      for (const p of rawPrice) {
        if (p !== null && !Number.isNaN(p)) last = p;
        price.push(last);
      }

      const currentQueue = Number(summary.current_queue_amount || 0);
      const avgQueue = Number(summary.avg_queue_amount_30d || 0);
      const avgDailyInit = Number(summary.avg_daily_initiated_30d || 0);
      const init7d = Number(summary.initiated_last_7d || 0);

      const avgUnlock = unlocks.reduce((a,b)=>a+b,0) / Math.max(unlocks.length,1);

      const delta = avgQueue === 0 ? 0 : ((currentQueue - avgQueue) / avgQueue) * 100;
      const deltaText = (delta >= 0 ? '+' : '') + delta.toFixed(1) + '% vs 30d avg';

      const kpis = [
        { title: 'Current Queue (7d)', value: fmt(currentQueue), sub: deltaText },
        { title: '30d Avg Queue', value: fmt(avgQueue), sub: 'Baseline' },
        { title: '30d Avg Daily Initiated', value: fmt(avgDailyInit), sub: 'Daily flow' },
        { title: 'Initiated Last 7d', value: fmt(init7d), sub: 'Recent pressure' }
      ];

      const kpiContainer = document.getElementById('kpis');
      kpis.forEach(k => {
        const div = document.createElement('div');
        div.className = 'panel';
        div.innerHTML = `<div class="kpi-title">${k.title}</div><div class="kpi-value">${k.value}</div><div class="kpi-delta">${k.sub}</div>`;
        kpiContainer.appendChild(div);
      });

      const labelsForward = [...labels, ...Array.from({length: 7}, (_, i) => {
        const d = new Date(labels[labels.length-1]);
        d.setDate(d.getDate() + (i+1));
        return d.toISOString().slice(0,10);
      })];
      const unlocksForward = [...unlocks, ...Array(7).fill(null)];
      const avgUnlockLine = labelsForward.map(() => avgUnlock);

      new Chart(document.getElementById('queueChart'), {
        type: 'line',
        data: {
          labels: labelsForward,
          datasets: [
            { label: 'Unlocks (Daily)', data: unlocksForward, borderColor: '#ffd18a', backgroundColor: 'rgba(255,209,138,0.15)', fill: true, tension: 0.2 },
            { label: 'Avg Unlocks (30d)', data: avgUnlockLine, borderColor: '#c3a6ff', borderDash: [6,6], pointRadius: 0, tension: 0 }
          ]
        },
        options: {
          plugins: { legend: { labels: { color: '#eef3ff' } } },
          scales: {
            x: { ticks: { color: '#a8b8d8', maxRotation: 0, autoSkip: true, maxTicksLimit: 10 } },
            y: { ticks: { color: '#a8b8d8' } }
          }
        }
      });

      new Chart(document.getElementById('initUnlockChart'), {
        type: 'line',
        data: { labels, datasets: [
          { label: 'Unlocks', data: unlocks, borderColor: '#ffd18a', backgroundColor: 'rgba(255,209,138,0.15)', fill: true, tension: 0.2, yAxisID: 'y' },
          { label: 'VVV Price (USD)', data: price, borderColor: '#6ea8ff', backgroundColor: 'rgba(110,168,255,0.10)', fill: false, tension: 0.2, yAxisID: 'y1', borderWidth: 2, pointRadius: 2 }
        ]},
        options: {
          plugins: { legend: { labels: { color: '#eef3ff' } } },
          scales: {
            x: { ticks: { color: '#a8b8d8', maxRotation: 0, autoSkip: true, maxTicksLimit: 10 } },
            y: { position: 'left', ticks: { color: '#a8b8d8' }, title: { display: true, text: 'Unlocks', color: '#a8b8d8' } },
            y1: { position: 'right', grid: { drawOnChartArea: false }, ticks: { color: '#a8b8d8' }, title: { display: true, text: 'Price (USD)', color: '#a8b8d8' } }
          }
        }
      });

      new Chart(document.getElementById('initChart'), {
        type: 'bar',
        data: { labels, datasets: [{ label: 'Daily Initiate Unstake', data: initiated, backgroundColor: '#8be9b5' }] },
        options: {
          plugins: { legend: { labels: { color: '#eef3ff' } } },
          scales: {
            x: { ticks: { color: '#a8b8d8', maxRotation: 0, autoSkip: true, maxTicksLimit: 10 } },
            y: { ticks: { color: '#a8b8d8' } }
          }
        }
      });
    })();
  </script>
</body>
</html>
